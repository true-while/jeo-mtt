@model JeoMTT.Models.JeoGame

@{
    ViewData["Title"] = "Question Board - " + Model.Name;
}

<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-12">
            <h1>@Model.Name</h1>
            <p class="text-muted">Fill in the questions for each category</p>
        </div>
    </div>

    <!-- Jeopardy Board -->
    <div class="row">
        <div class="col-md-12">
            <div class="jeopardy-board">
                <div class="board-wrapper">
                    <!-- Category Headers -->
                    <div class="board-row board-header">
                        @foreach (var category in Model.Categories)
                        {
                            <div class="board-cell category-header">
                                <strong>@category.Name</strong>
                            </div>
                        }
                    </div>

                    <!-- Question Grid (5 rows = 5 point values) -->
                    @for (int pointRow = 0; pointRow < 5; pointRow++)
                    {
                        var points = new[] { 100, 200, 300, 400, 500 }[pointRow];
                        <div class="board-row">
                            @foreach (var category in Model.Categories)
                            {
                                var question = category.Questions.FirstOrDefault(q => q.Points == points);
                                <div class="board-cell">
                                    @if (question != null)
                                    {
                                        <button class="question-btn answered" type="button" 
                                                data-category-id="@category.Id" 
                                                data-points="@points"
                                                title="Click to edit">
                                            <span class="points-value">@points</span>
                                            <span class="check-mark">âœ“</span>
                                        </button>
                                    }
                                    else
                                    {
                                        <button class="question-btn" type="button" 
                                                data-category-id="@category.Id" 
                                                data-points="@points"
                                                title="Click to add">
                                            @points
                                        </button>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="d-flex justify-content-between">
                <a href="@Url.Action("Details", "JeoGame", new { id = Model.Id })" class="btn btn-secondary btn-lg">
                    <i class="bi bi-arrow-left"></i> Back
                </a>
                <a href="@Url.Action("Index", "JeoGame")" class="btn btn-primary btn-lg">
                    <i class="bi bi-house"></i> Back to Games
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Question Modal -->
<div class="modal fade" id="questionModal" tabindex="-1" aria-labelledby="questionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="questionModalLabel">Add/Edit Question</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="questionForm">
                    <input type="hidden" id="categoryId" />
                    <input type="hidden" id="points" />

                    <div class="mb-3">
                        <label for="questionText" class="form-label">Question <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="questionText" name="questionText" rows="6" 
                                  placeholder="Enter your question here..." maxlength="200" required></textarea>
                        <small class="text-muted d-block mt-1">
                            <span id="charCount">0</span>/200 characters
                        </small>
                    </div>

                    <div class="mb-3">
                        <label for="answerText" class="form-label">Answer <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="answerText" name="answerText" rows="2" 
                                  placeholder="Enter the answer here..." required></textarea>
                    </div>

                    <div id="questionError" class="alert alert-danger" role="alert" style="display: none;"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveQuestionBtn">Save Question</button>
            </div>
        </div>
    </div>
</div>

<style>
    .jeopardy-board {
        background: linear-gradient(135deg, #001a4d 0%, #003d99 100%);
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        margin-bottom: 2rem;
    }

    .board-wrapper {
        display: grid;
        gap: 8px;
    }

    .board-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 8px;
    }

    .board-cell {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100px;
    }

    .category-header {
        background-color: rgba(255, 255, 255, 0.2);
        color: white;
        padding: 15px;
        border-radius: 5px;
        font-size: 1.1rem;
        font-weight: 600;
        text-align: center;
        min-height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        word-wrap: break-word;
    }

    .question-btn {
        width: 100%;
        height: 80px;
        border: none;
        border-radius: 5px;
        background-color: #FFD700;
        color: #001a4d;
        font-size: 1.5rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
        padding: 10px;
        text-shadow: none;
    }

    .question-btn:hover {
        background-color: #FFC700;
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    .question-btn:active {
        transform: scale(0.98);
    }

    .question-btn.answered {
        background-color: #666;
        color: white;
    }

    .question-btn.answered:hover {
        background-color: #777;
    }

    .check-mark {
        font-size: 1.2rem;
        margin-left: 5px;
    }

    .points-value {
        display: block;
        font-size: 1rem;
    }

    .modal-header {
        background-color: #0d6efd;
    }

    .form-label {
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .form-control:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }

    textarea.form-control {
        resize: vertical;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .btn {
        font-weight: 500;
        padding: 0.5rem 1.5rem;
    }

    .btn-lg {
        padding: 0.75rem 2rem;
        font-size: 1.1rem;
    }

    h1 {
        color: #001a4d;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    @media (max-width: 768px) {
        .board-row {
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 4px;
        }

        .board-cell {
            min-height: 80px;
        }

        .question-btn {
            height: 70px;
            font-size: 1.2rem;
        }

        .category-header {
            min-height: 70px;
            font-size: 0.9rem;
            padding: 10px;
        }
    }
</style>

@section Scripts {
    <script>
        const gameId = @Model.Id;
        let currentCategoryId = null;
        let currentPoints = null;

        // Question Modal
        const questionModal = new bootstrap.Modal(document.getElementById('questionModal'), {});
        const questionForm = document.getElementById('questionForm');
        const questionText = document.getElementById('questionText');
        const answerText = document.getElementById('answerText');
        const categoryIdInput = document.getElementById('categoryId');
        const pointsInput = document.getElementById('points');
        const charCount = document.getElementById('charCount');
        const questionError = document.getElementById('questionError');

        // Character count for question
        questionText.addEventListener('input', (e) => {
            charCount.textContent = e.target.value.length;
        });

        // Open modal when question button is clicked
        document.querySelectorAll('.question-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                currentCategoryId = parseInt(btn.dataset.categoryId);
                currentPoints = parseInt(btn.dataset.points);

                categoryIdInput.value = currentCategoryId;
                pointsInput.value = currentPoints;

                // Load existing question if it exists
                try {
                    const response = await fetch(`/JeoGame/GetQuestion?categoryId=${currentCategoryId}&points=${currentPoints}`);
                    if (response.ok) {
                        const data = await response.json();
                        questionText.value = data.text || '';
                        answerText.value = data.answer || '';
                        charCount.textContent = data.text ? data.text.length : 0;
                    }
                } catch (error) {
                    console.error('Error loading question:', error);
                }

                questionError.style.display = 'none';
                questionModal.show();
            });
        });

        // Save question
        document.getElementById('saveQuestionBtn').addEventListener('click', async () => {
            const qText = questionText.value.trim();
            const aText = answerText.value.trim();

            // Validation
            if (!qText) {
                showError('Question is required');
                return;
            }

            if (qText.length > 200) {
                showError('Question cannot exceed 200 characters');
                return;
            }

            if (!aText) {
                showError('Answer is required');
                return;
            }

            try {
                const response = await fetch('/JeoGame/SaveQuestion', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': document.querySelector('[name="__RequestVerificationToken"]')?.value || ''
                    },
                    body: new URLSearchParams({
                        'categoryId': currentCategoryId,
                        'points': currentPoints,
                        'questionText': qText,
                        'answerText': aText
                    })
                });

                if (response.ok) {
                    if (window.trackEvent) {
                        trackEvent('QuestionSaved', {
                            'categoryId': currentCategoryId.toString(),
                            'points': currentPoints.toString()
                        });
                    }

                    questionModal.hide();
                    // Reload page to show updated board
                    location.reload();
                } else {
                    const error = await response.text();
                    showError(error || 'Failed to save question');
                }
            } catch (error) {
                showError('Error: ' + error.message);
                if (window.trackEvent) {
                    trackEvent('QuestionSaveError', {
                        'error': error.message
                    });
                }
            }
        });

        function showError(message) {
            questionError.textContent = message;
            questionError.style.display = 'block';
        }

        // Track page view
        if (window.trackEvent) {
            trackEvent('PlayBoardPageViewed', {
                'gameId': gameId.toString(),
                'categoryCount': '@Model.Categories.Count'
            });
        }

        // Handle modal close
        document.getElementById('questionModal').addEventListener('hide.bs.modal', () => {
            questionForm.reset();
            charCount.textContent = '0';
            questionError.style.display = 'none';
        });
    </script>
}
